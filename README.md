## URL Shortener with Key Generation Service

## Installation

Composer, Docker Compose, & Apache running PHP 8 are necessary to run and test this application
1. Clone the repo into a working directory: `git clone https://github.com/Auvenell/url-shortener.git`
2. `cd url-shortener && composer update`
3. `docker-compose up -d`
4. Application should be running `http://localhost:8000` 
    - Container is named `sail-8.0/app`
    - Get Container ID with `docker ps`
    - Enter Container `docker exec -it <container ID> /bin/bash`
5. In container run: `php artisan migrate`
6. Enter MySQL container using method above and in container run:
    - `ALTER url-shortener url_handlers CHARACTER SET utf8 COLLATE utf8mb4_0900_as_cs;`
7. Open Browser and navigate to [http://localhost:8000/key-generate](http://localhost:8000/key-generate)
    - PLEASE WAIT for message: "Key Generation - Success"
8. This application is installed and ready to use 

## Using the API

- `/api/shorten`: To input a URL and receive a shortened URL via the API, format the request as follows:
    - `curl -X POST -d "url=<VALID URL>" http://localhost:8000/api/shorten`
    - Responses will be JSON format: `[{"Original URL":"<VALID URL>","Shortened URL":"http://localhost:8000/i","Access/Hit Count":0}]`

- `/api/check`: To input an already shortened URL and receive its target/original URL via the API, format the request as follows:
    - `curl -X POST -d "checkUrl=http://localhost:8000/<URL SUFFIX>" http://localhost:8000/api/check`
    - Responses will be JSON format: `[{"Checking URL":"http://localhost:8000/a","Directs to":"<VALID URL>"}]`

- `/api/toplist`: To retrieve a list of the top (up to 100) most visited short URLs via the API, format the request as follows:
    - `curl http://localhost:8000/api/toplist`
    - Responses will be JSON format with the following nodes: 
        - Access/Hit Count
        - Shortened URL
        - Original URL

## Using the web client

- Main Page `http://localhost:8000`
    - Enter valid URL into the text input field and press shorten - the page will return a hyperlink with the shortened URL
    - Clicking the hyperlink will navigate to the shortened url, then be redirected to the original (target)

- Top List `http://localhost:8000/top100`
    - Navigate to this page in order to see an organized list of the top accessed short URLS (up to 100)

## Project Design 

- There are a variety of ways to setup a url shortening service; this project implements a key generation script to fulfill the primary requirement of always returning the shortest URL possible. It also accomplishes the goal of keeping a production application as light as possible by reducing the amount of processing/hashing/matching aganist the database per visitor request 
    - The Key Generation script prepopulates the `short_url` column of the `url_handlers` table with every possible combination of characters in base64 up to 3 characters in length for a total of 262144 unique URLs (`/a`, `/b`, `/c` ... `/aa`, `/ab`, `/ac` ... `/aaa`, `/aab`, `/aac`)
    - Up to 6.87 billion keys can be pre-generated by uncommenting `lines 32-34` in `resources/views/keyGenerationService.blade.php` before running `http:/localhost:8000/key-generate` during setup (WARNING be prepared to wait for database operations to complete when going beyond ~260k records)
    - Incoming requests for shortened URLs are 'slotted' into the first available row and assigned a pre-generated short URL; this ensures that the shortest url possible is always assigned to the most recent visitor


## Project Challenges

- Issues with Docker on an M1 Mac - I needed to use the base laravel docker setup .yml files due to differences between my typical work PC and my development machine
    - Resolved: Unfortunately this meant using the apache and php combination installed on the host  

- Designing the Key Generation Service
    - Resolved: Took a few iterations before this was done correctly - several db migrations and rollbacks

- Getting all URLs that don't match a defined route to point to the `redirect`URL method 
    - Resolved: After mucking through HTTP exceptions, found success using `Route::fallback` in `routes/web.php`  

- Trouble returning the proper URL when dealing with lowercase vs uppercase and mixed case URLs
    - Resolved: Switching table collation to `utf8mb4_0900_as_cs` to retrieve case sensitive results

## Future Improvements

More time could see several improvements for the project

- An expiration service that would free up old or unused shortened URLs so that shorter URLs may be provided to newer visitors
- The bonus unfortunately not completed due to time constraints - which would be implemented via adding a checkbox flag on the homepage. Checking the box when submitting a URL for shortening would mark it as NSFW (which would be represented in the database with `2` in column `status`). New logic in the `redirectURL` method of the `UrlHandlerController` would check for `status = 2` and provide a boolean to be interpreted on urlRedirect.blade.php that would increase redirect time to 10 seconds (up from the standard 3 second redirect)
- User accounts and authentication to permit storage of URLs by account
- API security with token generation and authentication
- Integrate with a third-party NSFW blacklist to (domain level) block NSFW sites from being stored in the db
- Misc clean of API responses and better error handling across the board